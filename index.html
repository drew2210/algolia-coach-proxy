<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Algolia Coach</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background:#0b0f14; color:#e6edf3; }
      .wrap { max-width: 800px; margin: 0 auto; padding: 20px; }
      .card { background:#111823; border:1px solid #1f2a37; border-radius:12px; padding:16px; }
      .row { margin: 10px 0; }
      textarea { width:100%; min-height:80px; padding:10px; border-radius:10px; border:1px solid #2b3a4b; background:#0e1521; color:#e6edf3; }
      button { padding:10px 14px; border-radius:10px; border:1px solid #2b3a4b; background:#1a2433; color:#e6edf3; cursor:pointer; }
      .msg { white-space: pre-wrap; padding:10px; border-radius:10px; margin:8px 0; }
      .user { background:#0e1521; border:1px solid #202c3b; }
      .assistant { background:#0d1b2a; border:1px solid #1b2b3f; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h2>Algolia Coach</h2>
      <div class="card">
        <div id="chat"></div>
        <div class="row">
          <textarea id="input" placeholder="Ask: Show me the top no-result searches for electronics_kw_price_asc this week"></textarea>
        </div>
        <div class="row">
          <button id="send">Send</button>
        </div>
      </div>
    </div>

    <script>
      const chat = document.getElementById('chat');
      const input = document.getElementById('input');
      const send = document.getElementById('send');

      const messages = [];

      function add(role, text) {
        const div = document.createElement('div');
        div.className = 'msg ' + (role === 'user' ? 'user' : 'assistant');
        div.textContent = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
      }

      async function callAgent(prompt) {
        messages.push({ role: 'user', content: prompt });

        const r = await fetch('/.netlify/functions/agent-chat', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ messages }),
        });

        const data = await r.json();
        // Keep full message history returned by the server (includes tool results)
        if (Array.isArray(data.messages)) {
          messages.length = 0;
          messages.push(...data.messages);
        }
        return data.reply || '[No reply]';
      }

      send.onclick = async () => {
        const text = input.value.trim();
        if (!text) return;
        add('user', text);
        input.value = '';
        const reply = await callAgent(text);
        add('assistant', reply);
      };
    </script>
  </body>
</html>
